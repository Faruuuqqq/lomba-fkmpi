generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String?
  role          String    @default("USER")
  isActive      Boolean   @default(true)
  // Gamification fields
  tokens        Int       @default(5)  // Starting balance
  currentStreak Int       @default(0)
  lastActive    DateTime?
  lastChallenge DateTime? // Track daily quiz completion
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  projects      Project[]
  mediaFiles    MediaFile[]
}

model Project {
  id           String             @id @default(uuid())
  title        String
  content      String             @db.Text
  wordCount    Int                @default(0)
  isAiUnlocked Boolean            @default(false)
  status       String             @default("DRAFT")
  reflection   String?            @db.Text
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  userId       String
  user         User               @relation(fields: [userId], references: [id])
  snapshots    ProjectSnapshot[]
  aiChats      AiInteraction[]
  reasoningLogs ReasoningLog[]
  mediaFiles   MediaFile[]
}

model ProjectSnapshot {
  id        String   @id @default(uuid())
  content   String   @db.Text
  timestamp DateTime @default(now())
  stage     String
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
}

model AiInteraction {
  id          String   @id @default(uuid())
  userPrompt  String   @db.Text
  aiResponse  String   @db.Text
  timestamp   DateTime @default(now())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
}

model ReasoningLog {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  graphData   Json
  analysis    String   @db.Text
  timestamp   DateTime @default(now())
}

model AnalyticsLog {
  id        String   @id @default(uuid())
  userId    String?
  feature   String
  duration  Int
  timestamp DateTime @default(now())
  metadata  Json?
}

model RateLimit {
  id        String   @id @default(uuid())
  key       String   @unique
  count     Int      @default(0)
  resetTime DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("rate_limits")
}

model FailedLoginAttempt {
  id        String   @id @default(uuid())
  email     String
  ipAddress String
  userAgent String?
  timestamp DateTime @default(now())
  
  @@map("failed_login_attempts")
}

model AccountLockout {
  id         String   @id @default(uuid())
  email      String   @unique
  lockReason String
  lockedAt   DateTime @default(now())
  lockedUntil DateTime
  attempts   Int      @default(0)
  isActive   Boolean  @default(true)
  
  @@map("account_lockouts")
}

model MediaFile {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  projectId    String?
  userId       String
  uploadedAt   DateTime @default(now())
  project      Project? @relation(fields: [projectId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
  
  @@map("media_files")
}

model SavedPaper {
  id          String   @id @default(uuid())
  paperId     String   // OpenAlex ID or DOI
  title       String
  authors     String[] // Array of author names
  year        Int
  abstract    String?  @db.Text
  url         String?
  type        String   @default("journal") // journal, book, etc
  relevance   Int      @default(0)
  userId      String
  projectId   String?  // Optional: link to specific project
  savedAt     DateTime @default(now())
  
  @@unique([userId, paperId]) // Prevent duplicate saves
  @@map("saved_papers")
}

model BlacklistedToken {
  id        String   @id @default(uuid())
  token     String   // Hashed token value
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([expiresAt])
  @@map("blacklisted_tokens")
}
